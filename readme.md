# WinCheckBot

Бот для автоматической верификации сотрудников компании в Telegram-каналах и группах.

## Назначение

WinCheckBot обеспечивает автоматическую проверку сотрудников по рабочему email, управление доступом к корпоративным чатам, автоматическую синхронизацию с HR-экспортом и защиту от несанкционированного доступа.

## Основные функции

- Верификация пользователей по рабочему email (домен настраивается через переменные окружения)
- Генерация и отправка кода подтверждения на email
- FSM (Finite State Machine) для управления состояниями пользователя
- Автоматическое добавление/удаление пользователей из чатов и каналов
- Интеграция с cron для ежедневного экспорта/импорта пользователей
- Исключения для определённых email-адресов
- Уведомления уволенным сотрудникам
- Поддержка Redis для хранения FSM
- Логирование действий и ошибок

## Технологии

- [aiogram 3.x](https://docs.aiogram.dev/) — Telegram Bot API
- [aiosqlite](https://github.com/omnilib/aiosqlite) — асинхронная работа с SQLite
- [apscheduler](https://apscheduler.readthedocs.io/) — планировщик задач
- [python-dotenv](https://github.com/theskumar/python-dotenv) — переменные окружения
- [loguru](https://github.com/Delgan/loguru) — логирование
- [redis](https://redis.io/) — хранение FSM
- [SQLAlchemy](https://www.sqlalchemy.org/) — ORM (опционально)
- Docker/Docker Compose для развёртывания

## Структура проекта

```
wincheckbot/
  main.py                # Точка входа (бот)
  config.py              # Конфигурация и переменные окружения
  database.py            # Работа с БД
  handlers/              # Хэндлеры aiogram (FSM, команды, email, код и др.)
  utils/                 # Вспомогательные модули (email, крипто, file_ops и др.)
  combine/               # Тексты сообщений и клавиатуры
  scripts/               # Утилиты для тестирования и отладки
  export.py              # Экспорт пользователей (cron)
  import.py              # Импорт пользователей (cron)
  cleaner.py             # Очистка неактуальных пользователей (cron)
  all_users.py           # Экспорт всех пользователей
  exclusions.py          # Проверка исключений
  docker-compose.yml     # Docker Compose
  dockerfile             # Dockerfile
  requirements.txt       # Зависимости
  .env                   # Переменные окружения (не коммитить!)
```

## Быстрый старт

1. **Клонируйте репозиторий и установите зависимости:**

```bash
git clone ...
cd wincheckbot
pip install -r requirements.txt
```

2. **Создайте файл `.env` в корне проекта:**

```
TELEGRAM_API_TOKEN=...           # Токен Telegram-бота
COMPANY_CHANNEL_ID=...           # ID канала компании
WORK_MAIL=winline.ru             # Домен рабочей почты
UNI_EMAIL=...                    # Email для отправки писем
ENCRYPTION_KEY=...               # HEX-ключ AES (16/24/32 байта)
DB_PATH=./data/winbot.db         # Путь к базе данных
MAINTENANCE_MODE=0               # 1 — режим обслуживания
EXCLUDED_EMAILS=hr@winline.ru,...# Email-исключения через запятую
```

3. **Инициализируйте базу данных:**

```bash
python3 main.py  # При первом запуске создаст таблицы
```

4. **Запуск через Docker Compose:**

```bash
docker-compose up --build
```

5. **Cron-задачи:**

- Экспорт, импорт и очистка пользователей запускаются автоматически через cron внутри контейнера `cron`.

## Основные команды для пользователей

- `/start` — начать или повторить верификацию
- `/check` — проверить статус верификации
- `/instruction` — инструкция по верификации
- `/help` — список команд

## Для администраторов

- Скрипты в папке `scripts/` для тестирования почты, проверки переменных окружения, симуляции HR-экспорта и др.
- Логи — в папке `logs/`
- Экспортированные и импортированные файлы — в папках `export/` и `import/`

## Примечания

- Все переменные окружения должны быть корректно заданы, иначе бот не запустится.
- Для отправки email требуется рабочий SMTP-сервер.
- Для хранения FSM используется Redis (по умолчанию контейнер `redis`).
- Для миграций схемы используйте alembic (если потребуется).

## Контакты

Вопросы и предложения — к автору проекта или вашему DevOps/администратору. 