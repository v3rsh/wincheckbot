# Тестовые скрипты для работы с email

В этой директории содержатся скрипты для тестирования отправки email сообщений.

## Предварительные настройки

Для работы скриптов требуются переменные окружения, которые можно задать одним из способов:

1. **Через файл `.env`** - создайте файл `.env` в корневой директории проекта со следующими переменными:
   ```
   UNI_EMAIL=your_email@winline.ru
   UNI_API_KEY=your_api_key
   ```

2. **Через переменные окружения системы** - установите переменные окружения в системе:
   ```bash
   export UNI_EMAIL=your_email@winline.ru
   export UNI_API_KEY=your_api_key
   ```

## Скрипты

### check_env.py

Проверяет наличие необходимых переменных окружения для отправки email.

```bash
python scripts/check_env.py
```

### check_smtp.py

Проверяет доступность SMTP-сервера и поддержку TLS.

```bash
python scripts/check_smtp.py [сервер] [порт]
```

По умолчанию используется сервер `mail.winline.ru` и порт `25`.

### test_mail.py

Отправляет тестовое письмо с кодом подтверждения на указанный email.

```bash
python scripts/test_mail.py
```

## decrypt_emails.py

Скрипт для расшифровки email'ов в базе данных и перехода от шифрованного хранения к открытому.

### Использование

```bash
# Расшифровать все email'ы в базе данных
python scripts/decrypt_emails.py

# Только проверить статус расшифровки (без изменений)
python scripts/decrypt_emails.py --verify
```

### Что делает скрипт

1. **decrypt_all_emails()** - основная функция расшифровки:
   - Находит всех пользователей с email'ами в базе данных
   - Расшифровывает каждый email с помощью `decrypt_email()`
   - Заменяет зашифрованный email на расшифрованный
   - Логирует процесс с маскированием для безопасности
   - Записывает результат в SyncHistory

2. **verify_decryption()** - функция проверки:
   - Проверяет все email'ы в базе данных
   - Определяет, какие email'ы еще зашифрованы (hex строка)
   - Выводит статистику расшифрованных/зашифрованных email'ов

### Безопасность

- Все email'ы в логах маскируются с помощью `mask_email()`
- Скрипт обрабатывает ошибки расшифровки
- Результат записывается в SyncHistory для аудита

### После выполнения

После успешного выполнения скрипта:
1. Все email'ы в базе данных будут расшифрованы
2. Можно безопасно убрать шифрование из основного кода бота
3. Модуль `utils/crypto.py` можно будет удалить после проверки

### Пример вывода

```
=== Начало расшифровки email'ов в базе данных ===
Найдено 150 пользователей с email'ами.
Расшифрован email для пользователя 123456: us**@**.com
...
=== Расшифровка завершена ===
Успешно расшифровано: 150
Ошибок: 0
=== Проверка расшифровки email'ов ===
Проверка завершена:
Расшифрованных email'ов: 150
Зашифрованных email'ов: 0
✅ Все email'ы успешно расшифрованы!
```

## Особенности запуска

Скрипты содержат код для добавления родительской директории в `sys.path`, поэтому их можно запускать напрямую из любой директории:

```bash
# Из корневой директории проекта
python scripts/test_mail.py

# Из директории scripts
cd scripts
python test_mail.py
```

## Особенности реализации

1. Функция `send_test` в `utils/email_sender.py` теперь поддерживает:
   - Multipart/alternative (HTML + текстовая версия)
   - TLS-шифрование (если сервер поддерживает)
   - Дополнительные заголовки для предотвращения попадания в спам

2. В `scripts/test_mail.py` добавлен код для корректного импорта модулей из родительской директории 